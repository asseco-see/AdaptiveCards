variables:
- group: common

- name: buildContextFolder
  value: '.'

- name: imageRepository
  value: 'registry.see.asseco.com/platform/adaptive-ui'

- name: dockerfilePath
  value: 'Dockerfile'

pool: 'Digital'

steps:
- script: |
    sed -i 's/root: \//root: \/adaptive-ui/g' source/nodejs/adaptivecards-site/_config.yml
  displayName: 'CHANGE_site_path_root'

- task: DockerAdvanced@0
  displayName: 'COMMIT_install'
  inputs:
    image: 'node:12-slim'
    secureFile: npm-asee-dp-robot
    commands: |
      cp npm-asee-dp-robot /root/.npmrc
      cd source/nodejs
      npm install --no-progress --loglevel=warn
      npx lerna bootstrap
      npx lerna run build

- task: DockerAdvanced@0
  displayName: 'COMMIT_release'
  inputs:
    image: 'node:12-slim'
    commands: |
      cd source/nodejs/adaptivecards-site
      npx lerna run release

- task: DockerAdvanced@0
  displayName: 'COMMIT_generate_version'
  inputs:
    image: 'registry.see.asseco.com/tools/image-tagger'
    dockerRegistryEndpoint: harbor
    envVars: |
      TAGGER_VERSION=v2
      GITHUB_TOKEN=$(githubToken)

- script: |
    echo -e "\nCOPY --chown=1001:0 .version /" >> $(dockerfilePath)
  displayName: 'COMMIT_tag_version'
  
- task: DockerAdvanced@0
  displayName: 'COMMIT_NPM_publish_adaptivecards'
  inputs:
    image: 'registry.see.asseco.com/tools/angular-module-builder:11.0'
    dockerRegistryEndpoint: harbor
    secureFile: npm-asee-dp-robot
    commands: |
      cp npm-asee-dp-robot /root/.npmrc
      cd source/nodejs/adaptivecards
      npm run publish
      
- task: DockerAdvanced@0
  displayName: 'COMMIT_NPM_publish_adaptivecards_designer'
  inputs:
    image: 'registry.see.asseco.com/tools/angular-module-builder:11.0'
    dockerRegistryEndpoint: harbor
    secureFile: npm-asee-dp-robot
    commands: |
      cp npm-asee-dp-robot /root/.npmrc
      cd source/nodejs/adaptivecards-designer
      npm run publish

- task: DockerAdvanced@0
  displayName: 'COMMIT_publish'
  inputs:
    action: BuildAndPush
    context: $(buildContextFolder)
    image: $(imageRepository)
    dockerfile: $(dockerfilePath)
    dockerRegistryEndpoint: harbor

- task: DockerAdvanced@0
  displayName: 'COMMIT_publish_chart'
  inputs:
    image: 'registry.see.asseco.com/tools/helm-asseco-deploy'
    dockerRegistryEndpoint: harbor
    envVars: |
      HARBOR_URL=$(harborUrl)
      HARBOR_USERNAME=$(harborUsername)
      HARBOR_PASSWORD=$(harborPassword)

# - task: DockerAdvanced@0
#   displayName: 'ACCEPTANCE_setup_environment'
#   inputs:
#     image: 'alpine/helm'
#     commands: |
#       export CI_BUILD_TAG=$(cat .version)
#       helm upgrade --install adaptive-ui --namespace platform-docs charts/adaptive-ui --set image.tag=$CI_BUILD_TAG --kubeconfig k8s-asee-dp-robot --atomic
#     secureFile: k8s-asee-dp-robot

- script: |
    IFS=',' read -a tags <<< $(cat .tags)
    for tag in "${tags[@]}"
    do
      docker rmi $(imageRepository):${tag}
    done
  displayName: 'COMMIT_cleanup'
  condition: always()

- script: |
    echo -e "adaptive-ui" >> .name
  displayName: 'CD_PREPARATION_SERVICE_NAME'

- task: CopyFiles@2
  displayName: 'CD_PREPARATION_COPY'
  inputs:
    SourceFolder: '$(Build.SourcesDirectory)'
    Contents: |
      .version
      .name
    TargetFolder: '$(Build.ArtifactStagingDirectory)'

- task: PublishBuildArtifacts@1
  displayName: 'CD_PREPARATION_BUILD_ARTIFACTS'
  inputs:
    ArtifactName: 'CD_Data'